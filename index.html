<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDR-CAM - Aplicaci칩n de Captura de Fotos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游닝</text></svg>">
</head>
<body>
    <div class="container">
        <h1>GDR-CAM - Aplicaci칩n de Captura de Fotos V7</h1>
        
        <div id="camera-section">
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" width="640" height="480"></canvas>
            </div>
            
            <div class="controls">
                <button id="start-camera">Iniciar C치mara</button>
                <button id="take-photo" disabled>Tomar Foto</button>
            </div>
        </div>
        
        <div id="form-section" class="hidden">
            <h2>Formulario de Observaci칩n</h2>
            
            <div class="form-group">
                <label for="work-front">Frente de Trabajo:</label>
                <input type="text" id="work-front" required>
            </div>
            
            <div class="form-group">
                <label for="coronation">Coronamiento:</label>
                <input type="text" id="coronation" required>
            </div>
            
            <div class="form-group">
                <label for="observation-type">Tipo de Observaci칩n:</label>
                <select id="observation-type" required>
                    <option value="">Seleccione una opci칩n</option>
                    <option value="estructural">Estructural</option>
                    <option value="ambiental">Ambiental</option>
                    <option value="geotecnica">Geot칠cnica</option>
                    <option value="otro">Otro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="activity-performed">Actividad Realizada:</label>
                <textarea id="activity-performed" rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label for="gps-coords">Coordenadas GPS:</label>
                <input type="text" id="gps-coords" disabled>
            </div>
            
            <div class="action-buttons">
                <button id="save-metadata">Guardar Foto con Metadatos</button>
            </div>
        </div>
        
        <div id="result-section" class="result-container hidden">
            <h2>Foto Capturada</h2>
            <img id="photo-preview" src="" alt="Vista previa de la foto">
            <div class="action-buttons">
                <button id="new-capture">Nueva Captura</button>
                <button id="download-photo">Guardar en Galer칤a</button>
                <button id="view-metadata">Ver Metadatos</button>
            </div>
        </div>
        
        <div id="status-message" class="status hidden"></div>
    </div>

    <div id="metadata-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Metadatos de la Imagen</h2>
            <pre id="metadata-display"></pre>
        </div>
    </div>

    <script src="exif.js"></script>
    <script src="piexif.js"></script>
    <script src="save-image.js"></script>
    <script>
        // Variables para elementos del DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startCameraBtn = document.getElementById('start-camera');
        const takePhotoBtn = document.getElementById('take-photo');
        const formSection = document.getElementById('form-section');
        const resultSection = document.getElementById('result-section');
        const photoPreview = document.getElementById('photo-preview');
        const saveMetadataBtn = document.getElementById('save-metadata');
        const newCaptureBtn = document.getElementById('new-capture');
        const downloadPhotoBtn = document.getElementById('download-photo');
        const cameraSection = document.getElementById('camera-section');
        const statusMessage = document.getElementById('status-message');
        
        let stream = null;
        let imageCapture = null;
        let capturedPhotoDataUrl = null;
        let photoWithMetadata = null;
        let currentLocation = null;
        
        // Iniciar c치mara
        startCameraBtn.addEventListener('click', async () => {
            try {
                // Primero intentar con c치mara trasera (environment)
                const constraints = { 
                    video: { facingMode: 'environment' } 
                };
                
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (environmentError) {
                    console.warn('No se pudo acceder a la c치mara trasera, intentando con c치mara frontal:', environmentError);
                    // Si falla, intentar con c치mara frontal
                    const constraintsAlt = { 
                        video: { facingMode: 'user' } 
                    };
                    stream = await navigator.mediaDevices.getUserMedia(constraintsAlt);
                }
                
                video.srcObject = stream;
                const track = stream.getVideoTracks()[0];
                if (typeof ImageCapture !== 'undefined'){
                    imageCapture = new ImageCapture(track);
                }
                
                takePhotoBtn.disabled = true; // Disable until location is obtained
                startCameraBtn.disabled = true;
                showStatus('C치mara iniciada. Obteniendo ubicaci칩n...', 'success');
                
                // Intentar obtener la ubicaci칩n
                getCurrentLocation();
            } catch (err) {
                console.error('Error al acceder a la c치mara:', err);
                showStatus('Error al acceder a la c치mara. Aseg칰rese de permitir el acceso.', 'error');
            }
        });
        
        // Intentar obtener la ubicaci칩n actual
        function getCurrentLocation() {
            const gpsDisplay = document.getElementById('gps-coords');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            altitude: position.coords.altitude,
                            timestamp: position.timestamp
                        };
                        console.log('Ubicaci칩n obtenida:', currentLocation);
                        showStatus('Ubicaci칩n obtenida. Puede tomar una foto.', 'success');
                        gpsDisplay.value = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                        takePhotoBtn.disabled = false; // Enable photo taking
                    },
                    (error) => {
                        console.warn('No se pudo obtener la ubicaci칩n:', error.message);
                        showStatus('No se pudo obtener la ubicaci칩n. Puede tomar la foto sin datos de GPS.', 'error');
                        gpsDisplay.value = 'No se pudo obtener la ubicaci칩n.';
                        takePhotoBtn.disabled = false; // Enable photo taking anyway
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                console.warn('Geolocalizaci칩n no soportada');
                showStatus('La geolocalizaci칩n no es compatible con este navegador', 'error');
                gpsDisplay.value = 'Geolocalizaci칩n no soportada.';
                takePhotoBtn.disabled = false; // Enable photo taking anyway
            }
        }
        
        // Tomar foto
        takePhotoBtn.addEventListener('click', () => {
            const processImage = (imageSource) => {
                const canvas = document.createElement('canvas');
                canvas.width = imageSource.videoWidth || imageSource.width;
                canvas.height = imageSource.videoHeight || imageSource.height;
                const context = canvas.getContext('2d');
                context.drawImage(imageSource, 0, 0, canvas.width, canvas.height);
                capturedPhotoDataUrl = canvas.toDataURL('image/jpeg');

                video.srcObject = null;
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                cameraSection.classList.add('hidden');
                formSection.classList.remove('hidden');
                takePhotoBtn.disabled = true;
                startCameraBtn.disabled = false;
            };

            if (imageCapture) {
                imageCapture.takePhoto()
                    .then(blob => {
                        const image = new Image();
                        image.src = URL.createObjectURL(blob);
                        image.onload = () => {
                            processImage(image);
                        };
                    })
                    .catch(error => {
                        console.error('Error taking photo:', error);
                        showStatus('Error al tomar la foto.', 'error');
                    });
            } else {
                processImage(video);
            }
        });
        
        // Guardar foto con metadatos
        saveMetadataBtn.addEventListener('click', () => {
            const workFront = document.getElementById('work-front').value;
            const coronation = document.getElementById('coronation').value;
            const observationType = document.getElementById('observation-type').value;
            const activityPerformed = document.getElementById('activity-performed').value;
            
            if (!workFront || !coronation || !observationType || !activityPerformed) {
                showStatus('Por favor complete todos los campos del formulario.', 'error');
                return;
            }
            
            // Crear objeto de metadatos
            const metadata = {
                workFront,
                coronation,
                observationType,
                activityPerformed,
                location: currentLocation,
                timestamp: new Date().toLocaleString() // Using local time format instead of ISO string
            };
            
            // Mostrar indicador de carga
            saveMetadataBtn.innerHTML = '<span class="loading"></span> Procesando...';
            saveMetadataBtn.disabled = true;
            
            // A침adir los metadatos a la imagen
            addMetadataToImage(capturedPhotoDataUrl, metadata);
        });
        
        // Funci칩n para a침adir metadatos a la imagen
        function addMetadataToImage(imageDataUrl, metadata) {
            console.log("Iniciando addMetadataToImage");
            console.log("imageDataUrl (primeros 100 caracteres):", imageDataUrl.slice(0, 100));
            if (typeof piexif !== 'undefined' && piexif.dump) {
                try {
                    console.log("Cargando EXIF data desde la imagen...");
                    let exifObj = piexif.load(imageDataUrl);
                    console.log("EXIF data cargado:", JSON.parse(JSON.stringify(exifObj)));

                    if (!exifObj) {
                        console.log("No se encontr칩 EXIF data, creando objeto vac칤o.");
                        exifObj = {"0th": {}, "Exif": {}, "GPS": {}, "Interop": {}, "thumbnail": null};
                    }

                    console.log("Metadata a agregar:", metadata);
                    
                    // Handle the encoding of the user comment
                    let userComment;
                    if (piexif.helper && piexif.helper.encodeToUnicode) {
                        userComment = piexif.helper.encodeToUnicode(JSON.stringify(metadata));
                    } else {
                        // Fallback: try to use the simpler ASCII encoding
                        // First, ensure metadata is properly stringified and encode safely
                        const metadataStr = JSON.stringify(metadata);
                        // Convert the string to a format that piexif can handle
                        userComment = "ASCII\0" + metadataStr;
                    }
                    
                    exifObj["Exif"][piexif.ExifIFD.UserComment] = userComment;
                    console.log("UserComment agregado al objeto EXIF.");

                    if (metadata.location) {
                        console.log("Agregando datos GPS...");
                        const lat = metadata.location.latitude;
                        const lng = metadata.location.longitude;
                        const latRef = lat >= 0 ? "N" : "S";
                        const lngRef = lng >= 0 ? "E" : "W";
                        const absLat = Math.abs(lat);
                        const absLng = Math.abs(lng);
                        const latDeg = Math.floor(absLat);
                        const latMin = Math.floor((absLat - latDeg) * 60);
                        const latSec = Math.floor(((absLat - latDeg) * 60 - latMin) * 60 * 1000) / 1000;
                        const lngDeg = Math.floor(absLng);
                        const lngMin = Math.floor((absLng - lngDeg) * 60);
                        const lngSec = Math.floor(((absLng - lngDeg) * 60 - lngMin) * 60 * 1000) / 1000;

                        exifObj["GPS"] = {
                            [piexif.GPSIFD.GPSVersionID]: [2, 2, 0, 0],
                            [piexif.GPSIFD.GPSLatitudeRef]: latRef,
                            [piexif.GPSIFD.GPSLatitude]: [[latDeg, 1], [latMin, 1], [Math.floor(latSec * 1000), 1000]],
                            [piexif.GPSIFD.GPSLongitudeRef]: lngRef,
                            [piexif.GPSIFD.GPSLongitude]: [[lngDeg, 1], [lngMin, 1], [Math.floor(lngSec * 1000), 1000]]
                        };

                        if (metadata.location.altitude !== null && metadata.location.altitude !== undefined) {
                            const alt = Math.abs(metadata.location.altitude);
                            const altRef = metadata.location.altitude >= 0 ? 0 : 1;
                            exifObj["GPS"][piexif.GPSIFD.GPSAltitudeRef] = altRef;
                            exifObj["GPS"][piexif.GPSIFD.GPSAltitude] = [Math.floor(alt * 1000), 1000];
                        }
                        console.log("Datos GPS agregados:", exifObj["GPS"]);
                    }

                    const now = new Date();
                    const dateTimeOriginal = now.getFullYear() + ":" + 
                        String(now.getMonth() + 1).padStart(2, '0') + ":" + 
                        String(now.getDate()).padStart(2, '0') + " " +
                        String(now.getHours()).padStart(2, '0') + ":" + 
                        String(now.getMinutes()).padStart(2, '0') + ":" + 
                        String(now.getSeconds()).padStart(2, '0');
                    exifObj["Exif"][piexif.ExifIFD.DateTimeOriginal] = dateTimeOriginal;
                    exifObj["0th"][piexif.ImageIFD.DateTime] = dateTimeOriginal;
                    console.log("Objeto EXIF final antes de 'dump':", JSON.parse(JSON.stringify(exifObj)));

                    const exifBytes = piexif.dump(exifObj);
                    console.log("EXIF data convertido a bytes.");

                    const newImage = piexif.insert(exifBytes, imageDataUrl);
                    console.log("Nueva imagen creada con EXIF data insertado.");

                    photoWithMetadata = newImage;
                    photoPreview.src = newImage;
                    formSection.classList.add('hidden');
                    resultSection.classList.remove('hidden');
                    showStatus('춰Foto guardada con metadatos!', 'success');
                    saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                    saveMetadataBtn.disabled = false;

                } catch (err) {
                    console.error('Error en addMetadataToImage:', err);
                    showStatus('Error al guardar los metadatos.', 'error');
                    saveMetadataBtn.innerHTML = 'Guardar Foto con Metadatos';
                    saveMetadataBtn.disabled = false;
                }
            } else {
                console.warn('piexif no est치 disponible.');
                showStatus('La librer칤a para metadatos no est치 disponible.', 'error');
            }
        }
        
        // Event listener para guardar en galer칤a
        downloadPhotoBtn.addEventListener('click', () => {
            if (!photoWithMetadata) {
                showStatus('No hay imagen para guardar', 'error');
                return;
            }
            saveToGallery(photoWithMetadata);
        });
        
        // Nueva captura
        newCaptureBtn.addEventListener('click', () => {
            resultSection.classList.add('hidden');
            cameraSection.classList.remove('hidden');
            startCameraBtn.disabled = false;
            takePhotoBtn.disabled = true;
            
            // Limpiar campos del formulario
            document.getElementById('work-front').value = '';
            document.getElementById('coronation').value = '';
            document.getElementById('observation-type').value = '';
            document.getElementById('activity-performed').value = '';
            
            // Restablecer el texto del bot칩n de guardar en galer칤a si estaba cambiado
            if (downloadPhotoBtn.innerHTML.includes('Guardando...') || 
                downloadPhotoBtn.innerHTML.includes('Guardando en galer칤a') || 
                downloadPhotoBtn.innerHTML.includes('Descargando...')) {
                downloadPhotoBtn.innerHTML = 'Guardar en Galer칤a';
                downloadPhotoBtn.disabled = false;
            }
        });
        
        // Funci칩n para mostrar mensajes de estado
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }
        
        // Verificar soporte de Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado con 칠xito:', registration);
                    })
                    .catch(error => {
                        console.log('Error al registrar ServiceWorker:', error);
                    });
            });
        }

        // Modal de metadatos
        const viewMetadataBtn = document.getElementById('view-metadata');
        const metadataModal = document.getElementById('metadata-modal');
        const closeButton = document.querySelector('.close-button');
        const metadataDisplay = document.getElementById('metadata-display');

        viewMetadataBtn.addEventListener('click', () => {
            if (photoWithMetadata) {
                const exifObj = piexif.load(photoWithMetadata);
                let metadataText = '';

                // Display User Comment (form data)
                if (exifObj.Exif && exifObj.Exif[piexif.ExifIFD.UserComment]) {
                    try {
                        let userComment;
                        if (piexif.helper && piexif.helper.decodeFromUnicode) {
                            userComment = piexif.helper.decodeFromUnicode(exifObj.Exif[piexif.ExifIFD.UserComment]);
                        } else {
                            // Fallback: if the decodeFromUnicode method is not available,
                            // try to extract the string manually (assuming ASCII\0 prefix was used)
                            const comment = exifObj.Exif[piexif.ExifIFD.UserComment];
                            if (comment.startsWith('ASCII\0')) {
                                userComment = comment.substring(6); // Remove 'ASCII\0' prefix
                            } else {
                                userComment = comment;
                            }
                        }
                        const jsonData = JSON.parse(userComment);
                        metadataText += 'Datos del Formulario:\n';
                        metadataText += JSON.stringify(jsonData, null, 2);
                        metadataText += '\n\n';
                    } catch (e) {
                        console.error('Error parsing user comment:', e);
                        metadataText += 'Datos del Formulario (no se pudo decodificar):\n';
                        metadataText += exifObj.Exif[piexif.ExifIFD.UserComment] + '\n\n';
                    }
                } else {
                    metadataText += 'No se encontraron datos del formulario en los metadatos.\n\n';
                }

                // Display GPS data
                if (exifObj.GPS && Object.keys(exifObj.GPS).length > 0) {
                    metadataText += 'Datos GPS:\n';
                    for (const tag in exifObj.GPS) {
                        const tagName = piexif.GPSIFD[tag] || `Unknown Tag (${tag})`;
                        metadataText += `${tagName}: ${exifObj.GPS[tag]}\n`;
                    }
                } else {
                    metadataText += 'No se encontraron datos GPS en los metadatos.\n';
                }

                metadataDisplay.textContent = metadataText;
                metadataModal.classList.remove('hidden');
            } else {
                showStatus('No hay foto para ver los metadatos.', 'error');
            }
        });

        closeButton.addEventListener('click', () => {
            metadataModal.classList.add('hidden');
        });

        window.addEventListener('click', (event) => {
            if (event.target == metadataModal) {
                metadataModal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>